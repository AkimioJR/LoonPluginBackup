name: Auto Backup Loon Plugins

on:
  schedule:
    - cron: "0 0 */2 * *"
  workflow_dispatch:
    inputs:
      clean:
        description: "æ˜¯å¦æ¸…ç†å·²æœ‰æ–‡ä»¶ (true/false)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Initialization environment
        run: |
          sudo timedatectl set-timezone "Asia/Shanghai"
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run backup script
        run: |
          # è®¾ç½®cleanå‚æ•°ï¼šæ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥å€¼ï¼Œè‡ªåŠ¨è¿è¡Œæ—¶é»˜è®¤ä¸ºfalse
          CLEAN_ARG=""
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.clean }}" = "true" ]; then
              CLEAN_ARG="--clean"
            fi
          fi

          echo "è¿è¡Œå‘½ä»¤: python scripts/main.py $CLEAN_ARG"
          python scripts/main.py $CLEAN_ARG

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"
            
            # æ£€æŸ¥Lpxæ’ä»¶å˜åŒ–
            CHANGED_PLUGINS=$(git status --porcelain | grep -E "kelee/Lpx/.*\.lpx$" | awk '{print $2}' | sed 's|kelee/Lpx/||' | sed 's|\.lpx$||' | sort | head -20)
            if [ -n "$CHANGED_PLUGINS" ]; then
              PLUGIN_LIST=$(echo "$CHANGED_PLUGINS" | tr '\n' ', ' | sed 's|, $||')
              echo "plugins=$PLUGIN_LIST" >> $GITHUB_OUTPUT
              echo "å‘ç°æ’ä»¶å˜åŒ–: $PLUGIN_LIST"
            else
              echo "plugins=" >> $GITHUB_OUTPUT
              echo "ä»…éæ’ä»¶æ–‡ä»¶å‘ç”Ÿå˜åŒ–"
            fi
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "plugins=" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"
          fi

      - name: Commit and push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git add .

          # æ„å»ºcommitæ¶ˆæ¯
          COMMIT_TITLE="ğŸš€ update $(date +'%Y-%m-%d %H:%M:%S UTC+8')"
          CHANGED_PLUGINS="${{ steps.verify-changed-files.outputs.plugins }}"
          COMMIT_BODY=""
          if [ -n "$CHANGED_PLUGINS" ]; then
            COMMIT_BODY="\n\næ›´æ–°æ’ä»¶åˆ—è¡¨:\n$CHANGED_PLUGINS"
          fi
          git commit -m "$COMMIT_TITLE" -m "$COMMIT_BODY"
          git push origin main

          TAG_NAME=$(python scripts/version.py)

          echo "åˆ›å»ºtag: $TAG_NAME"
          git tag -a "$TAG_NAME" -m "ğŸš€ Update on $(date +'%Y-%m-%d %H:%M:%S UTC+8')"
          git push origin "$TAG_NAME"


          echo "âœ… å¤‡ä»½å®Œæˆï¼"
          echo "ğŸ“ å˜åŒ–å·²æäº¤åˆ°mainåˆ†æ”¯"
          echo "ğŸ·ï¸ æ–°tagå·²åˆ›å»º: $TAG_NAME"
          if [ -n "$CHANGED_PLUGINS" ]; then
            echo "ğŸ“¦ æ›´æ–°çš„æ’ä»¶: $CHANGED_PLUGINS"
          fi

      - name: No changes summary
        if: steps.verify-changed-files.outputs.changed == 'false'
        run: |
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–ï¼Œè·³è¿‡æäº¤å’Œtagåˆ›å»º"
